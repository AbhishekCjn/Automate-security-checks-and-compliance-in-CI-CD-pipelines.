name: Security Scan (Snyk)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * 1-5'  # Every weekday at 3 AM
  pull_request:
    branches: [main]

jobs:
  snyk-scan:
    name: snyk-iac-scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Snyk CLI
        uses: snyk/actions/setup@v1
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: Run Snyk IaC Scan
        run: snyk iac test --json-file-output=snyk-results.json || echo "No IaC issues found"
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: Upload Snyk Results
        uses: actions/upload-artifact@v4
        with:
          name: snyk-iac-results
          path: snyk-results.json
